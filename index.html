<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Weather Animation Test</title>
<style>
  body {
    margin: 0;
    padding: 0;
    background: #37393d;
    color: #f5f5f5;
    font-family: Arial, sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }
  .weather-widget {
    position: fixed;
    top: 1rem;
    right: 1rem;
    background: rgba(45,47,51,0.8);
    padding: 1rem 1.5rem;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 1.1rem;
    opacity: 0;
    transform: translateY(-20px);
    transition: opacity 0.5s ease, transform 0.5s ease;
  }
  .weather-widget.visible {
    opacity: 1;
    transform: translateY(0);
  }
  .weather-icon {
    font-size: 1.8rem;
  }

  /* Animations */
  @keyframes rain {
    0% { background-position: 0 0; }
    100% { background-position: 0 100%; }
  }
  @keyframes snow {
    0% { background-position: 0 0; }
    100% { background-position: 20px 100px; }
  }
  @keyframes wind {
    0% { transform: translateX(0); }
    100% { transform: translateX(20px); }
  }
  .weather-rain,
  .weather-snow,
  .weather-wind,
  .weather-sunny {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    pointer-events: none;
    z-index: -1;
    opacity: 0.5;
    display: none; /* Hide initially */
  }
  .weather-rain {
    background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="20" height="100" viewBox="0 0 20 100"><line x1="10" y1="0" x2="10" y2="100" stroke="rgba(148,163,184,0.3)" stroke-width="1"/></svg>') repeat;
    background-size: 20px 100px;
    animation: rain 1s linear infinite;
  }
  .weather-snow {
    background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 40 40"><circle cx="20" cy="20" r="2" fill="rgba(148,163,184,0.5)"/></svg>') repeat;
    background-size: 40px 40px;
    animation: snow 10s linear infinite;
  }
  .weather-wind {
    background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="20" viewBox="0 0 100 20"><path d="M0,10 Q25,5 50,10 T100,10" stroke="rgba(148,163,184,0.3)" stroke-width="1" fill="none"/></svg>') repeat;
    background-size: 100px 20px;
    animation: wind 5s linear infinite;
    opacity: 0.3;
  }
  .weather-sunny {
    background: radial-gradient(circle at 10% 20%, rgba(251, 191, 36, 0.1) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(245, 158, 11, 0.1) 0%, transparent 20%);
    opacity: 0.2;
  }
</style>
</head>
<body>

<div class="weather-rain"></div>
<div class="weather-snow"></div>
<div class="weather-wind"></div>
<div class="weather-sunny"></div>

<div class="weather-widget" id="weather-widget" aria-live="polite" role="region">
  <span class="weather-icon" id="weather-icon">üå§Ô∏è</span>
  <span id="weather-text">Loading weather...</span>
</div>

<script>
  async function fetchWeatherAndAnimate() {
    const widget = document.getElementById('weather-widget');
    const iconElem = document.getElementById('weather-icon');
    const textElem = document.getElementById('weather-text');

    try {
      // Get user location from ipapi.co
      const ipResponse = await fetch('https://ipapi.co/json/');
      if (!ipResponse.ok) throw new Error('Failed to get IP location');
      const ipData = await ipResponse.json();
      const { latitude, longitude } = ipData;
      if (typeof latitude !== 'number' || typeof longitude !== 'number') {
        throw new Error('Invalid location data');
      }

      // Query Open-Meteo current weather
      const weatherURL = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true`;
      const weatherResponse = await fetch(weatherURL);
      if (!weatherResponse.ok) throw new Error('Failed to get weather data');
      const weatherData = await weatherResponse.json();
      if (!weatherData.current_weather) throw new Error('No current weather data');

      const code = weatherData.current_weather.weathercode;
      const temperature = Math.round(weatherData.current_weather.temperature);

      // Map weathercode to icon and animation type
      const weatherMap = {
        0: { icon: '‚òÄÔ∏è', animation: 'sunny', label: 'Clear' },
        1: { icon: '‚õÖ', animation: 'sunny', label: 'Mainly Clear' },
        2: { icon: 'üå§Ô∏è', animation: 'sunny', label: 'Partly Cloudy' },
        3: { icon: '‚òÅÔ∏è', animation: 'sunny', label: 'Overcast' },
        45: { icon: 'üå´Ô∏è', animation: 'wind', label: 'Fog' },
        48: { icon: 'üå´Ô∏è', animation: 'wind', label: 'Depositing Rime Fog' },
        51: { icon: 'üå¶Ô∏è', animation: 'rain', label: 'Light Drizzle' },
        53: { icon: 'üå¶Ô∏è', animation: 'rain', label: 'Drizzle' },
        55: { icon: 'üå¶Ô∏è', animation: 'rain', label: 'Dense Drizzle' },
        56: { icon: 'üåßÔ∏è', animation: 'rain', label: 'Light Freezing Drizzle' },
        57: { icon: 'üåßÔ∏è', animation: 'rain', label: 'Dense Freezing Drizzle' },
        61: { icon: 'üåßÔ∏è', animation: 'rain', label: 'Slight Rain' },
        63: { icon: 'üåßÔ∏è', animation: 'rain', label: 'Rain' },
        65: { icon: 'üåßÔ∏è', animation: 'rain', label: 'Heavy Rain' },
        66: { icon: 'üåßÔ∏è', animation: 'rain', label: 'Light Freezing Rain' },
        67: { icon: 'üåßÔ∏è', animation: 'rain', label: 'Heavy Freezing Rain' },
        71: { icon: '‚ùÑÔ∏è', animation: 'snow', label: 'Slight Snow Fall' },
        73: { icon: '‚ùÑÔ∏è', animation: 'snow', label: 'Snow Fall' },
        75: { icon: '‚ùÑÔ∏è', animation: 'snow', label: 'Heavy Snow Fall' },
        77: { icon: '‚ùÑÔ∏è', animation: 'snow', label: 'Snow Grains' },
        80: { icon: 'üåßÔ∏è', animation: 'rain', label: 'Slight Rain Showers' },
        81: { icon: 'üåßÔ∏è', animation: 'rain', label: 'Rain Showers' },
        82: { icon: 'üåßÔ∏è', animation: 'rain', label: 'Heavy Rain Showers' },
        85: { icon: '‚ùÑÔ∏è', animation: 'snow', label: 'Slight Snow Showers' },
        86: { icon: '‚ùÑÔ∏è', animation: 'snow', label: 'Heavy Snow Showers' },
        95: { icon: '‚õàÔ∏è', animation: 'wind', label: 'Thunderstorm' },
        96: { icon: '‚õàÔ∏è', animation: 'wind', label: 'Thunderstorm with Slight Hail' },
        99: { icon: '‚õàÔ∏è', animation: 'wind', label: 'Thunderstorm with Heavy Hail' }
      };

      const weatherInfo = weatherMap[code] || { icon: 'üå§Ô∏è', animation: 'sunny', label: 'Unknown Weather' };

      // Update widget UI
      iconElem.textContent = weatherInfo.icon;
      textElem.textContent = `${temperature}¬∞C, ${weatherInfo.label}`;
      widget.classList.add('visible');

      // Show corresponding animation and hide others
      const allowedTypes = ['rain', 'snow', 'wind', 'sunny'];
      allowedTypes.forEach(type => {
        const el = document.querySelector('.weather-' + type);
        if (el) el.style.display = 'none';
      });
      const activeAnim = document.querySelector('.weather-' + weatherInfo.animation);
      if (activeAnim) activeAnim.style.display = 'block';

    } catch (error) {
      console.error('Weather fetch error:', error);
      widget.style.display = 'none';

      // Hide all animations on error
      ['rain','snow','wind','sunny'].forEach(type => {
        const el = document.querySelector('.weather-' + type);
        if (el) el.style.display = 'none';
      });
    }
  }

  // Call fetchWeatherAndAnimate on page load
  window.addEventListener('load', () => {
    fetchWeatherAndAnimate();
  });
</script>
</body>
</html>
